name: Sync Upstream Releases

on:
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:
    inputs:
      repositories:
        description: 'è¦åŒæ­¥çš„ä»“åº“åˆ—è¡¨ (æ ¼å¼: owner/repo, å¤šä¸ªç”¨é€—å·åˆ†éš”)'
        required: false

jobs:
  sync-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TARGET_REPO: "dkyg666/sync"  # âœ… åœ¨ job å±‚çº§æ˜ç¡®å®šä¹‰ç¯å¢ƒå˜é‡

    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤2: å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq
          # ä¿®å¤å¯†é’¥ç›®å½•æƒé™
          sudo mkdir -p /usr/share/keyrings
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install -y gh

      # æ­¥éª¤3: ç¡®å®šä»“åº“åˆ—è¡¨
      - name: Determine repositories
        id: set-repos
        run: |
          if [ -n "${{ github.event.inputs.repositories }}" ]; then
            REPOSITORIES="${{ github.event.inputs.repositories }}"
          elif [ -n "${{ vars.UPSTREAM_REPOSITORIES }}" ]; then
            REPOSITORIES="${{ vars.UPSTREAM_REPOSITORIES }}"
          else
            REPOSITORIES="AlistGo/alist"  # é»˜è®¤ä»“åº“
          fi
          echo "REPOSITORIES=${REPOSITORIES}" >> $GITHUB_OUTPUT

      # æ­¥éª¤4: æ‰§è¡ŒåŒæ­¥
      - name: Process repositories
        env:
          GH_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}  # ç›®æ ‡ä»“åº“ä¸“ç”¨ Token
        run: |
          set -euo pipefail  # å¯ç”¨ä¸¥æ ¼æ¨¡å¼
          echo "::group::åŒæ­¥æ—¥å¿—"  # æŠ˜å æ—¥å¿—

          mkdir -p sync-history
          echo "${{ steps.set-repos.outputs.REPOSITORIES }}" | tr ',' '\n' | while read -r upstream_repo; do
            # è§£æä»“åº“ä¿¡æ¯
            owner=$(cut -d/ -f1 <<< "$upstream_repo")
            repo_name=$(cut -d/ -f2 <<< "$upstream_repo")
            history_file="sync-history/${owner}_${repo_name}.txt"

            echo "ğŸ” æ£€æŸ¥ä»“åº“: $upstream_repo"

            # è·å–æœ€æ–° Release ä¿¡æ¯
            response=$(curl -sL \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/$upstream_repo/releases/latest")

            tag_name=$(jq -r '.tag_name' <<< "$response")
            if [[ "$tag_name" == "null" || -z "$tag_name" ]]; then
              echo "âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆ Release: $upstream_repo"
              continue
            fi

            # æ£€æŸ¥åŒæ­¥çŠ¶æ€
            last_synced=$(cat "$history_file" 2>/dev/null || echo "init")
            if [[ "$tag_name" == "$last_synced" ]]; then
              echo "âœ… å·²åŒæ­¥æœ€æ–°ç‰ˆæœ¬: $tag_name"
              continue
            fi

            echo "ğŸ”„ å‘ç°æ–°ç‰ˆæœ¬: $tag_name"

            # ä¸‹è½½æºç 
            zip_url=$(jq -r '.zipball_url' <<< "$response")
            wget -q -O "${repo_name}-${tag_name}.zip" "$zip_url"

            # åˆ›å»º Release (å…³é”®ä¿®å¤ç‚¹: æ­£ç¡®å¼•ç”¨ TARGET_REPO)
            echo "â¬†ï¸ ä¸Šä¼ åˆ°ç›®æ ‡ä»“åº“: $TARGET_REPO"  # âœ… ç›´æ¥ä½¿ç”¨å˜é‡å
            gh release create "sync/$repo_name/$tag_name" \
              "${repo_name}-${tag_name}.zip" \
              --title "Synced from $upstream_repo - $tag_name" \
              --notes "Automatically synced from upstream" \
              --repo "$TARGET_REPO"  # âœ… æ­£ç¡®å¼•ç”¨ç¯å¢ƒå˜é‡

            # è®°å½•åŒæ­¥çŠ¶æ€
            echo "$tag_name" > "$history_file"
            rm -f "${repo_name}-${tag_name}.zip"
          done

          echo "::endgroup::"

      # æ­¥éª¤5: æäº¤è®°å½•
      - name: Commit sync history
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          if git add sync-history && [ -n "$(git status --porcelain)" ]; then
            git commit -m "ğŸ“š æ›´æ–°åŒæ­¥è®°å½•: ${{ steps.set-repos.outputs.REPOSITORIES }}"
            git push "https://$GH_TOKEN@github.com/$GITHUB_REPOSITORY.git"
          else
            echo "ğŸ”„ æ— å˜æ›´éœ€è¦æäº¤"
          fi
